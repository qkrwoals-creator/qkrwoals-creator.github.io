<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>자리 배정 프로그램</title>
<style>
body {
  font-family: 'Pretendard','Noto Sans KR',sans-serif;
  margin:0;
  background:#000;
  color:#fff;
  min-height:100vh;
  display:flex;
  flex-direction:column;
  align-items:center;
}
header {
  position:sticky;
  top:0;
  width:100%;
  background:#000;
  color:#fff;
  text-align:center;
  padding:15px 0;
  font-weight:700;
  font-size:1.5rem;
  box-shadow:0 2px 8px rgba(255,255,255,0.1);
  z-index:10;
}
main {
  background:#000;
  border-radius:20px;
  box-shadow:0 0 20px rgba(255,255,255,0.1);
  width:90%;
  max-width:900px;
  padding:30px;
  margin:40px 0;
  color:#fff;
}
h2, h3 { color:#fff; }
input, textarea {
  border:none;
  border-radius:10px;
  padding:12px;
  width:80%;
  max-width:400px;
  margin:8px 0;
  font-size:1rem;
  background:#111;
  color:#fff;
  box-shadow:inset 0 1px 4px rgba(255,255,255,0.1);
  outline:none;
  transition:0.3s;
}
input:focus, textarea:focus {
  box-shadow:0 0 6px rgba(255,255,255,0.8);
}
button {
  background:#fff;
  color:#000;
  border:none;
  border-radius:8px;
  padding:10px 16px;
  margin:6px;
  cursor:pointer;
  font-weight:600;
  transition:0.25s ease;
  box-shadow:0 3px 10px rgba(255,255,255,0.2);
}
button:hover {
  background:#ccc;
  transform:translateY(-2px);
  box-shadow:0 5px 15px rgba(255,255,255,0.3);
}
#classroom {
  margin-top:20px;
  font-weight:600;
  color:#fff;
  min-height:200px;
  line-height:1.8;
  font-size:1rem;
  white-space:pre;
}
.seat {
  display:inline-block;
  padding:6px 12px;
  border-radius:8px;
  background:#111;
  color:#fff;
  margin:3px;
  cursor:grab;
  border:1px solid #333;
}
#vote-modal {
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.9);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:100;
}
#vote-box {
  background:#000;
  border-radius:10px;
  padding:20px 30px;
  text-align:center;
  width:90%;
  max-width:400px;
  color:#fff;
  box-shadow:0 0 20px rgba(255,255,255,0.1);
}
#vote-result { margin-top:15px; font-weight:600; color:#fff; }
footer {
  margin-bottom:20px;
  color:#555;
  font-size:0.9rem;
}
</style>
</head>
<body>
<header>자리 배정 프로그램</header>
<main>
<section id="login-section">
  <h2>로그인 / 회원가입</h2>
  <input type="text" id="username" placeholder="이름 또는 학번 입력"><br>
  <input type="password" id="password" placeholder="비밀번호 입력"><br>
  <button onclick="login()">로그인</button>
  <button onclick="register()">회원가입</button>
</section>

<section id="seat-section" style="display:none;">
  <h2 id="welcome"></h2>
  <h3>학생 목록 입력 / CSV 업로드</h3>
  <textarea id="studentList" rows="5" placeholder="학생 이름을 줄바꿈으로 입력"></textarea><br>
  <input type="file" id="csvFile" accept=".csv"><button onclick="loadCSV()">CSV 업로드</button><br>

  <h3>자리 배치 행 x 열 설정</h3>
  <input type="number" id="rows" placeholder="행 수" min="1" style="width:35%;"> x 
  <input type="number" id="cols" placeholder="열 수" min="1" style="width:35%;"><br>

  <button onclick="createSeats()">자리 만들기</button>
  <button onclick="shuffleWithAnimation()">자리 섞기</button>
  <button onclick="exportImage()">PNG 저장</button>
  <button onclick="resetSeats()">초기화</button>

  <div id="classroom"></div>
  <div id="info"></div>
  <button id="open-vote" style="display:none;" onclick="openVote()">투표장 열기</button>
</section>
</main>

<div id="vote-modal">
  <div id="vote-box">
    <h3 id="vote-title">투표 중</h3>
    <p id="vote-student"></p>
    <button onclick="castVote(true)">찬성</button>
    <button onclick="castVote(false)">반대</button>
    <div id="vote-result"></div>
  </div>
</div>

<footer>© 2025 자리 배정 시스템</footer>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
let loggedInUser=null;
let students=[];
let seats=[];
let currentVoteIndex=0;
let voteResults={};

function register(){
  const name=document.getElementById("username").value.trim();
  const pw=document.getElementById("password").value;
  if(!name||!pw) return alert("이름과 비밀번호를 모두 입력하세요.");
  if(localStorage.getItem(`pw_${name}`)) return alert("이미 존재하는 이름입니다.");
  localStorage.setItem(`pw_${name}`,pw);
  alert("회원가입 완료. 로그인해주세요.");
}

function login(){
  const name=document.getElementById("username").value.trim();
  const pw=document.getElementById("password").value;
  if(!name||!pw) return alert("이름과 비밀번호를 모두 입력하세요.");
  const savedPw=localStorage.getItem(`pw_${name}`);
  if(!savedPw) return alert("등록되지 않은 사용자입니다.");
  if(savedPw!==pw) return alert("비밀번호가 틀렸습니다.");
  loggedInUser=name;
  document.getElementById("login-section").style.display="none";
  document.getElementById("seat-section").style.display="block";
  document.getElementById("welcome").innerText=`${name}님 환영합니다`;
  loadSeats();
}

function loadCSV(){
  const file=document.getElementById("csvFile").files[0];
  if(!file) return alert("파일을 선택하세요.");
  const reader=new FileReader();
  reader.onload=e=>{
    const text=e.target.result;
    students=text.split("\n").map(s=>s.trim()).filter(s=>s);
    document.getElementById("studentList").value=students.join("\n");
  };
  reader.readAsText(file,"UTF-8");
}

function createSeats(){
  const list=document.getElementById("studentList").value.trim();
  const rows=parseInt(document.getElementById("rows").value);
  const cols=parseInt(document.getElementById("cols").value);
  if(!list) return alert("학생 목록을 입력하세요.");
  if(!rows||!cols) return alert("행과 열을 입력하세요.");
  students=list.split("\n").map(s=>s.trim()).filter(s=>s);
  if(rows*cols<students.length) return alert("자리보다 학생이 많습니다.");
  generateSeats(students,rows,cols);
}

function generateSeats(names,rows,cols){
  const container=document.getElementById("classroom");
  container.innerHTML="";
  seats=[];
  let idx=0;
  for(let r=0;r<rows;r++){
    let line="";
    for(let c=0;c<cols;c++){
      const seatName=names[idx]||"빈자리";
      const span=document.createElement("span");
      span.classList.add("seat");
      span.textContent=seatName;
      seats.push(span);
      line+=seatName+" ";
      idx++;
    }
    container.innerHTML+=line+"<br>";
  }
  document.getElementById("open-vote").style.display="none";
}

function shuffleWithAnimation(){
  if(students.length===0) return;
  const info=document.getElementById("info");
  let count=0;
  const interval=setInterval(()=>{
    for(let s of seats){
      s.textContent=students[Math.floor(Math.random()*students.length)]||"빈자리";
    }
    info.innerText=["자리 섞는 중","잠시만 기다려주세요","진행 중"][count%3];
    count++;
    if(count>5){
      clearInterval(interval);
      for(let i=students.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [students[i],students[j]]=[students[j],students[i]];
      }
      const rows=parseInt(document.getElementById("rows").value);
      const cols=parseInt(document.getElementById("cols").value);
      generateSeats(students,rows,cols);
      info.innerText="자리 섞기 완료";
      document.getElementById("open-vote").style.display="block";
    }
  },800);
}

function openVote(){
  if(students.length===0) return alert("학생 목록이 없습니다.");
  currentVoteIndex=0;
  voteResults={};
  document.getElementById("vote-modal").style.display="flex";
  showVoteStudent();
}

function showVoteStudent(){
  const student=students[currentVoteIndex];
  document.getElementById("vote-student").innerText=`${student}의 투표`;
  document.getElementById("vote-result").innerText=`(${currentVoteIndex+1}/${students.length})`;
}

function castVote(choice){
  const student=students[currentVoteIndex];
  voteResults[student]=choice;
  currentVoteIndex++;
  if(currentVoteIndex<students.length){
    showVoteStudent();
  } else {
    finishVoting();
  }
}

function finishVoting(){
  const yesCount=Object.values(voteResults).filter(v=>v===true).length;
  const total=students.length;
  document.getElementById("vote-modal").style.display="none";
  if(yesCount>=Math.ceil(total/2)){
    alert(`찬성 ${yesCount}/${total} 과반수 승인`);
  } else {
    alert(`찬성 ${yesCount}/${total} 과반수 미달`);
    shuffleWithAnimation();
  }
}

function exportImage(){
  const target=document.getElementById("classroom");
  html2canvas(target,{backgroundColor:"#000"}).then(canvas=>{
    const link=document.createElement("a");
    link.download="seats.png";
    link.href=canvas.toDataURL("image/png");
    link.click();
  });
}

function loadSeats(){
  const savedStudents=localStorage.getItem(`students_${loggedInUser}`)||"";
  if(savedStudents) document.getElementById("studentList").value=savedStudents;
}

function resetSeats(){
  students=[]; seats=[];
  document.getElementById("classroom").innerHTML="";
  document.getElementById("studentList").value="";
  document.getElementById("info").innerText="";
  document.getElementById("open-vote").style.display="none";
}
</script>
</body>
</html>
